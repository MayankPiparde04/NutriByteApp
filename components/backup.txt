// ree

import { Ionicons } from "@expo/vector-icons";
import * as ImagePicker from "expo-image-picker";
import { LinearGradient } from "expo-linear-gradient";
import { useRouter } from "expo-router";
import React, { useEffect, useRef, useState } from "react";
import {
  Alert,
  Animated,
  FlatList,
  Image,
  Keyboard,
  KeyboardAvoidingView,
  Platform,
  Text,
  TextInput,
  TouchableOpacity,
  useColorScheme,
  View,
} from "react-native";
import { useSafeAreaInsets } from "react-native-safe-area-context";

export default function REE() {
  const isDark = useColorScheme() === "dark";
  const router = useRouter();
  const [keyboardHeight] = useState(new Animated.Value(0));
  const insets = useSafeAreaInsets();

  useEffect(() => {
    const showEvent =
      Platform.OS === "ios" ? "keyboardWillShow" : "keyboardDidShow";
    const hideEvent =
      Platform.OS === "ios" ? "keyboardWillHide" : "keyboardDidHide";

    const showSub = Keyboard.addListener(showEvent, (e) => {
      Animated.timing(keyboardHeight, {
        toValue: e.endCoordinates.height,
        duration: Platform.OS === "ios" ? e.duration || 250 : 250,
        useNativeDriver: false,
      }).start();
    });

    const hideSub = Keyboard.addListener(hideEvent, (e) => {
      Animated.timing(keyboardHeight, {
        toValue: 0,
        duration: Platform.OS === "ios" ? e.duration || 250 : 250,
        useNativeDriver: false,
      }).start();
    });

    return () => {
      showSub.remove();
      hideSub.remove();
    };
  }, []);

  type Message = {
    id: string;
    text?: string;
    imageUri?: string;
    fromAI: boolean;
    timestamp: number;
  };

  const [messages, setMessages] = useState<Message[]>([]);
  const [inputText, setInputText] = useState("");
  const flatListRef = useRef<FlatList>(null);

  async function getAIResponse(userText: string): Promise<Message> {
    await new Promise((r) => setTimeout(r, 1200));
    return {
      id: Date.now().toString(),
      text: `REE: `,
      fromAI: true,
      timestamp: Date.now(),
    };
  }

  const sendMessage = async () => {
    if (!inputText.trim()) return;

    const userMsg: Message = {
      id: Date.now().toString(),
      text: inputText.trim(),
      fromAI: false,
      timestamp: Date.now(),
    };

    setMessages((prev) => [...prev, userMsg]);
    setInputText("");

    // Scroll to end after adding user message
    setTimeout(() => {
      flatListRef.current?.scrollToEnd({ animated: true });
    }, 100);

    const aiMsg = await getAIResponse(userMsg.text!);
    setMessages((prev) => [...prev, aiMsg]);

    // Scroll to end after adding AI message
    setTimeout(() => {
      flatListRef.current?.scrollToEnd({ animated: true });
    }, 100);
  };

  const pickImage = async () => {
    try {
      const permissionResult =
        await ImagePicker.requestMediaLibraryPermissionsAsync();
      if (!permissionResult.granted) {
        Alert.alert("Permission required", "Camera roll permission is needed.");
        return;
      }
      const pickerResult = await ImagePicker.launchImageLibraryAsync({
        mediaTypes: ImagePicker.MediaTypeOptions.Images,
        quality: 0.7,
      });
      if (!pickerResult.canceled) {
        sendImageMessage(pickerResult.assets[0].uri);
      }
    } catch (e) {
      Alert.alert("Error", "Could not access gallery");
    }
  };

  const takePhoto = async () => {
    try {
      const permissionResult =
        await ImagePicker.requestCameraPermissionsAsync();
      if (!permissionResult.granted) {
        Alert.alert("Permission required", "Camera permission is needed.");
        return;
      }
      const cameraResult = await ImagePicker.launchCameraAsync({
        quality: 0.7,
      });
      if (!cameraResult.canceled) {
        sendImageMessage(cameraResult.assets[0].uri);
      }
    } catch (e) {
      Alert.alert("Error", "Could not access camera");
    }
  };

  const sendImageMessage = async (uri: string) => {
    const userImgMsg: Message = {
      id: Date.now().toString(),
      imageUri: uri,
      fromAI: false,
      timestamp: Date.now(),
    };

    setMessages((prev) => [...prev, userImgMsg]);

    // Scroll to end after adding user image
    setTimeout(() => {
      flatListRef.current?.scrollToEnd({ animated: true });
    }, 100);

    await new Promise((r) => setTimeout(r, 1500));

    const aiImgMsg: Message = {
      id: (Date.now() + 1).toString(),
      text: "AI: I analyzed your image! Here's what I found...",
      fromAI: true,
      timestamp: Date.now() + 1,
    };

    setMessages((prev) => [...prev, aiImgMsg]);
    setTimeout(() => {
      flatListRef.current?.scrollToEnd({ animated: true });
    }, 100);
  };

  const renderMessage = ({ item }: { item: Message }) => {
    const isUser = !item.fromAI;

    return (
      <View className={`px-4 mb-4 ${isUser ? "items-end" : "items-start"}`}>
        <View
          className={`max-w-[80%] rounded-2xl overflow-hidden ${
            isUser
              ? isDark ? "bg-blue-600" : "bg-blue-500"
              : isDark
                ? "bg-gray-800 border border-gray-700"
                : "bg-white border border-gray-200"
          }`}
          style={{
            shadowColor: "#000",
            shadowOffset: { width: 0, height: 2 },
            shadowOpacity: isDark ? 0.3 : 0.1,
            shadowRadius: 4,
            elevation: 4,
          }}
        >
          {item.text ? (
            <View className="p-4">
              <Text
                className={`text-base leading-6 ${
                  isUser
                    ? "text-white font-medium"
                    : isDark
                      ? "text-gray-100"
                      : "text-gray-800"
                }`}
              >
                {item.text}
              </Text>
            </View>
          ) : item.imageUri ? (
            <View className="p-2">
              <Image
                source={{ uri: item.imageUri }}
                className="w-56 h-56 rounded-xl"
                resizeMode="cover"
              />
            </View>
          ) : null}
        </View>

        <Text
          className={`text-xs mt-1 px-2 ${
            isDark ? "text-gray-500" : "text-gray-400"
          }`}
        >
          {new Date(item.timestamp).toLocaleTimeString([], {
            hour: "2-digit",
            minute: "2-digit",
          })}
        </Text>
      </View>
    );
  };

  return (
    <View
      style={{ flex: 1, paddingTop: insets.top }}
      className={isDark ? "bg-gray-950" : "bg-gray-50"}
    >
      {/* Header */}
      <View
        className={`pb-4 pt-2 ${isDark ? "bg-gray-900" : "bg-white"}`}
        style={{
          shadowColor: "#000",
          shadowOffset: { width: 0, height: 2 },
          shadowOpacity: isDark ? 0.3 : 0.1,
          shadowRadius: 4,
          elevation: 4,
        }}
      >
        <View className="flex-row items-center justify-between px-4">
          <TouchableOpacity
            onPress={() => {
              try {
                router.back();
              } catch (error) {
                console.log("Navigation error:", error);
              }
            }}
            className={`p-3 rounded-full ${
              isDark ? "bg-gray-800" : "bg-gray-100"
            }`}
          >
            <Ionicons
              name="arrow-back"
              size={24}
              color={isDark ? "#e5e7eb" : "#374151"}
            />
          </TouchableOpacity>

          <View className="items-center">
            <Text
              className={`text-2xl font-bold ${
                isDark ? "text-white" : "text-gray-900"
              }`}
            >
              REE
            </Text>
            <Text
              className={`text-sm ${
                isDark ? "text-gray-400" : "text-gray-500"
              }`}
            >
              AI Nutrition Assistant
            </Text>
          </View>

          <TouchableOpacity
            onPress={() => {
              try {
                router.push("/(tabs)/profile");
              } catch (error) {
                console.log("Navigation error:", error);
              }
            }}
            className={`p-3 rounded-full ${
              isDark ? "bg-gray-800" : "bg-gray-100"
            }`}
          >
            <Ionicons
              name="person-circle"
              size={24}
              color={isDark ? "#e5e7eb" : "#374151"}
            />
          </TouchableOpacity>
        </View>
      </View>

      {/* Messages area */}
      <View className="flex-1">
        {messages.length === 0 ? (
          <View className="flex-1 justify-center items-center px-8">
            <View
              className={`w-20 h-20 rounded-full items-center justify-center mb-4 ${
                isDark ? "bg-gray-800" : "bg-white"
              }`}
              style={{
                shadowColor: "#000",
                shadowOffset: { width: 0, height: 2 },
                shadowOpacity: isDark ? 0.3 : 0.1,
                shadowRadius: 4,
                elevation: 4,
              }}
            >
              <Ionicons
                name="chatbubbles"
                size={32}
                color={isDark ? "#6b7280" : "#9ca3af"}
              />
            </View>
            <Text
              className={`text-xl font-semibold mb-2 ${
                isDark ? "text-gray-200" : "text-gray-700"
              }`}
            >
              Welcome to REE!
            </Text>
            <Text
              className={`text-center leading-6 ${
                isDark ? "text-gray-400" : "text-gray-500"
              }`}
            >
              Ask me anything about nutrition, send photos of your meals, or get
              personalized dietary advice.
            </Text>
          </View>
        ) : (
          <FlatList
            ref={flatListRef}
            data={messages}
            renderItem={renderMessage}
            keyExtractor={(item) => item.id}
            contentContainerStyle={{ paddingTop: 16, paddingBottom: 20 }}
            showsVerticalScrollIndicator={false}
            className="flex-1"
            onContentSizeChange={() => {
              if (messages.length > 0) {
                flatListRef.current?.scrollToEnd({ animated: true });
              }
            }}
          />
        )}
      </View>

      {/* Input area */}
      <KeyboardAvoidingView
        behavior={Platform.OS === "ios" ? "padding" : undefined}
        keyboardVerticalOffset={0}
      >
        <Animated.View
          style={{
            paddingBottom: Platform.OS === "ios" 
              ? insets.bottom 
              : Animated.add(keyboardHeight, insets.bottom),
          }}
        >
          <View
            className={`px-4 py-4 ${isDark ? "bg-gray-900" : "bg-white"}`}
            style={{
              shadowColor: "#000",
              shadowOffset: { width: 0, height: -2 },
              shadowOpacity: isDark ? 0.3 : 0.1,
              shadowRadius: 4,
              elevation: 4,
            }}
          >
            <View className="flex-row items-end space-x-3">
              {/* Camera button */}
              <TouchableOpacity
                onPress={takePhoto}
                className={`p-3 rounded-full ${isDark ? "bg-green-600" : "bg-green-500"}`}
              >
                <Ionicons name="camera" size={24} color="white" />
              </TouchableOpacity>

              {/* Gallery button */}
              <TouchableOpacity
                onPress={pickImage}
                className={`p-3 rounded-full ${isDark ? "bg-purple-600" : "bg-purple-500"}`}
              >
                <Ionicons name="image" size={24} color="white" />
              </TouchableOpacity>

              {/* Text input */}
              <View className="flex-1">
                <TextInput
                  className={`px-4 py-3 rounded-2xl border text-base ${
                    isDark
                      ? "bg-gray-800 border-gray-600 text-white"
                      : "bg-gray-50 border-gray-300 text-gray-900"
                  }`}
                  placeholder="Type your message..."
                  placeholderTextColor={isDark ? "#9ca3af" : "#6b7280"}
                  value={inputText}
                  onChangeText={setInputText}
                  multiline
                  maxLength={1000}
                  style={{
                    maxHeight: 100,
                  }}
                />
              </View>

              {/* Send button */}
              <TouchableOpacity
                onPress={sendMessage}
                disabled={!inputText.trim()}
                className={`p-3 rounded-full ${
                  inputText.trim()
                    ? isDark ? "bg-blue-600" : "bg-blue-500"
                    : isDark
                      ? "bg-gray-700"
                      : "bg-gray-300"
                }`}
              >
                <Ionicons
                  name="send"
                  size={20}
                  color={
                    inputText.trim() ? "white" : isDark ? "#6b7280" : "#9ca3af"
                  }
                />
              </TouchableOpacity>
            </View>
          </View>
        </Animated.View>
      </KeyboardAvoidingView>
    </View>
  );
}
                